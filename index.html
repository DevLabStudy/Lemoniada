<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lemoniada</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #FFD600; --accent: #38bdf8; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; text-align: center; margin: 0; padding: 20px; }

        .status-bar { background: var(--card); padding: 10px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #334155; }
        .cups-count { color: var(--primary); font-weight: 900; font-size: 1.2rem; }

        .menu-grid { display: grid; gap: 15px; max-width: 500px; margin: auto; }
        .item { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }

        .btn-add { background: var(--primary); border: none; padding: 10px 20px; border-radius: 12px; font-weight: 800; cursor: pointer; }

        .cart-box { background: var(--primary); color: #000; padding: 20px; border-radius: 25px; margin-top: 30px; position: sticky; bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .btn-order { background: #000; color: #fff; border: none; width: 100%; padding: 15px; border-radius: 15px; font-weight: 900; margin-top: 10px; cursor: pointer; }

        input#promo-code { background: rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; margin-bottom: 10px; width: 80%; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Lemoniada </h1>

    <div class="status-bar">
        Dostpne kubeczki: <span class="cups-count" id="cups-display">--</span>
    </div>

    <div class="menu-grid">
        <div class="item">
            <div><b>Klasyczna</b><br><small>5.00 z</small></div>
            <button class="btn-add" onclick="addToCart('Zwyka', 5)">DODAJ</button>
        </div>
        <div class="item">
            <div><b>Pomaraczowa</b><br><small>7.00 z</small></div>
            <button class="btn-add" onclick="addToCart('Pomaracz', 7)">DODAJ</button>
        </div>
    </div>

    <div id="cart-ui" class="cart-box" style="display: none;">
        <h3 style="margin: 0 0 10px 0;">Twoje zam贸wienie:</h3>
        <div id="cart-items" style="margin-bottom: 10px; font-weight: bold;"></div>

        <input type="text" id="promo-code" placeholder="KOD RABATOWY">

        <div style="font-size: 0.8rem; margin-bottom: 10px;">Patno przy odbiorze (Got贸wka/BLIK)</div>
        <button class="btn-order" onclick="sendOrder()">ZAMW I ZAPA NA MIEJSCU</button>
    </div>

    <script>
        const API = "https://api.lemoniada.com.pl";
        let cart = [];

        // 1. SYNCHRONIZACJA KUBECZKW
        async function updateStock() {
            try {
                const r = await fetch(`${API}/api/zapas`);
                const d = await r.json();
                document.getElementById('cups-display').innerText = d.kubeczki;

                // Jeli brak kubeczk贸w, zablokuj przyciski
                const btns = document.querySelectorAll('.btn-add');
                btns.forEach(b => b.disabled = d.kubeczki <= 0);
            } catch (e) {
                console.error("Bd poczenia z serwerem");
            }
        }

        // 2. OBSUGA KOSZYKA
        function addToCart(nazwa, cena) {
            let item = cart.find(x => x.nazwa === nazwa);
            if(item) item.sztuk++;
            else cart.push({nazwa, cena, sztuk: 1});

            renderCart();
        }

        function renderCart() {
            const ui = document.getElementById('cart-ui');
            const list = document.getElementById('cart-items');

            if(cart.length > 0) {
                ui.style.display = "block";
                list.innerText = cart.map(x => `${x.nazwa} x${x.sztuk}`).join(', ');
            } else {
                ui.style.display = "none";
            }
        }

        // 3. WYSYANIE ZAMWIENIA
        async function sendOrder() {
            const kod = document.getElementById('promo-code').value;

            const res = await fetch(`${API}/api/zamow`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    koszyk: cart,
                    kod: kod,
                    platnosc: "Odbi贸r osobisty"
                })
            });

            if(res.ok) {
                const data = await res.json();
                alert(`Zam贸wienie przyjte! Numer: #${data.id}\nZapraszamy do stoiska!`);
                cart = [];
                document.getElementById('promo-code').value = "";
                renderCart();
                updateStock();
            } else {
                const err = await res.json();
                alert("Bd: " + (err.error || "Nie udao si zo偶y zam贸wienia"));
            }
        }

        // Odwie偶anie zapasu co 5 sekund
        setInterval(updateStock, 5000);
        updateStock();
    </script>
</body>
</html>