<script>
    const API = "https://ensemble-seafood-wiki-richard.trycloudflare.com";
    let cart = [];

    // ... reszta funkcji (addToCart, showPayment) bez zmian ...

    function finalizuj(metoda) {
        const sum = cart.reduce((a, b) => a + b.price, 0).toFixed(2);
        const produkty = cart.map(i => i.name).join(", ");

        fetch(`${API}/zamow`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ produkty, suma: sum, platnosc: metoda })
        })
            .then(r => r.json())
            .then(data => {
                const orderId = data.id; // Pobieramy ID zamówienia z Twojego Linuxa
                document.getElementById('payment-modal').style.display='none';
                document.getElementById('cart-section').style.display='none';
                cart = [];

                // Start śledzenia statusu
                trackStatus(orderId);
            })
            .catch(err => alert("Błąd połączenia z serwerem PC!"));
    }

    function trackStatus(id) {
        const container = document.getElementById('status-container');
        container.innerHTML = `<div class="status-box" id="status-info">Twoje zamówienie (ID: ${id}) zostało PRZYJĘTE.</div>`;

        // Sprawdzaj status co 3 sekundy
        const interval = setInterval(() => {
            fetch(`${API}/list-zamowienia`)
                .then(r => r.json())
                .then(data => {
                    const myOrder = data.find(o => o.id === id);
                    if(myOrder) {
                        const info = document.getElementById('status-info');
                        info.innerHTML = `Status zamówienia: <b>${myOrder.status}</b>`;

                        if(myOrder.status === 'REALIZUJEMY') {
                            info.parentElement.style.background = "#d1ecf1"; // Kolor niebieskawy
                        }

                        if(myOrder.status === 'GOTOWE') {
                            info.innerHTML = "✨ <b>TWOJA LEMONIADA JEST GOTOWA!</b> ✨<br>Zapraszamy do odbioru.";
                            info.parentElement.style.background = "#d4edda"; // Kolor zielony
                            clearInterval(interval); // Zatrzymujemy sprawdzanie
                        }
                    }
                });
        }, 3000);
    }
</script>